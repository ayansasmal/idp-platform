apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: unleash-vs
  namespace: unleash
spec:
  hosts:
  - unleash.local
  - localhost
  gateways:
  - istio-system/main-gateway
  - mesh
  http:
  - match:
    - headers:
        host:
          prefix: unleash.local
    - headers:
        host:
          prefix: localhost
      port: 4243
    route:
    - destination:
        host: unleash.unleash.svc.cluster.local
        port:
          number: 4242
    corsPolicy:
      allowOrigins:
      - prefix: "http://localhost"
      - prefix: "https://localhost"
      - prefix: "http://unleash.local"
      - prefix: "https://unleash.local"
      allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      - PATCH
      allowHeaders:
      - Content-Type
      - Authorization
      - X-Requested-With
      - Accept
      - Origin
      - Access-Control-Request-Method
      - Access-Control-Request-Headers
      allowCredentials: true
      maxAge: 24h
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: unleash-dr
  namespace: unleash
spec:
  host: unleash.unleash.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 50
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 10